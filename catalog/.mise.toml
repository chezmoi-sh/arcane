# Copyright (C) 2024 Alexandre Nicolaie (xunleii@users.noreply.github.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ----------------------------------------------------------------------------

[env]
K3D_CLUSTER_NAME = "atlas-catalog"
KUBECONFIG = "{{env.DIRENV_LAYOUTDIR}}/kubernetes/{{env.K3D_CLUSTER_NAME}}.kubeconfig"

[tasks."k3d:prepare:traefik-ingress"]
description = "Installs the traefik ingress controller in the k3d cluster `atlas-catalog`"
run = [
  "helm repo add traefik https://helm.traefik.io/traefik --force-update",
  "helm repo update",
  '''
    helm upgrade --install traefik \
        --kube-context k3d-${K3D_CLUSTER_NAME} \
        --namespace traefik-system --create-namespace \
        --set experimental.kubernetesGateway.enabled=true \
        --set gateway.enabled=false \
        --set ingressClass.enabled=false \
        --set ports.ldap.expose.default=true \
        --set ports.ldap.exposedPort=389 \
        --set ports.ldap.hostPort=389 \
        --set ports.ldap.port=8389 \
        --set ports.ldap.protocol=TCP \
        --set ports.web.hostPort=80 \
        --set providers.kubernetesCRD.enabled=false \
        --set providers.kubernetesGateway.enabled=true \
        --set providers.kubernetesGateway.experimentalChannel=true \
        --set providers.kubernetesIngress.enabled=false \
        traefik/traefik
    ''',
]
