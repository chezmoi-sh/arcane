---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tailscale-ingress-restricted
  annotations:
    networkpolicy.kubernetes.io/description: >-
      Restricts network traffic for Tailscale ingress pods by denying all incoming connections
      while permitting outbound traffic to in-cluster services and external public internet addresses.
      Explicitly blocks communication to private IP ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)
      to prevent potential lateral movement and maintain network segmentation.
spec:
  podSelector:
    matchLabels:
      tailscale.com/managed: "true"
      tailscale.com/parent-resource-type: ingress
  policyTypes:
    - Ingress
    - Egress
  ingress: []
  egress:
    # Allow egress traffic to in-cluster services and external public internet addresses
    - to:
        - namespaceSelector: {}
    # Allow egress traffic to external public internet addresses while blocking private IP ranges
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
