# Copyright (C) 2024 Alexandre Nicolaie (xunleii@users.noreply.github.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ----------------------------------------------------------------------------

[env]
ATLAS_ROOTDIR = "{{config_root}}"
DIRENV_LAYOUTDIR = "{{config_root}}/.direnv"

HELM_CACHE_HOME = "{{env.DIRENV_LAYOUTDIR}}/helm/cache"
HELM_CONFIG_HOME = "{{env.DIRENV_LAYOUTDIR}}/helm/config"
HELM_DATA_HOME = "{{env.DIRENV_LAYOUTDIR}}/helm/data"

KIND_CONFIG = "{{config_root}}/kind.yaml"
# NOTE: Generate dynamically the cluster name based on where the kind configuration is stored
KIND_CLUSTER_NAME = '''
{%- set cluster_name = env.KIND_CONFIG
    | replace(from='/kind.yaml', to='')
    | replace(from=env.ATLAS_ROOTDIR, to='')
    | slugify
    | spaceless -%}
{%- if cluster_name == '' -%}atlas{%- else -%}atlas-{{cluster_name}}{%- endif -%}
'''
KUBECONFIG = "{{env.DIRENV_LAYOUTDIR}}/kubernetes/{{env.KIND_CLUSTER_NAME}}.kubeconfig"

# -- Global tasks definition
# --- Development tasks
[tasks."dev:start"]
description = "Prepare the development environment"
run = ["mise run kind:create", "mise run kind:prepare"]

[tasks."dev:teardown"]
description = "Tears down the development environment"
run = "mise run kind:delete"

# --- Kind related tasks
[tasks."kind:create"]
description = "Starts a kind cluster"
run = "kind create cluster --config ${KIND_CONFIG} --name ${KIND_CLUSTER_NAME}"

[tasks."kind:prepare"]
description = "Prepares the kind cluster"
depends = ["kind:prepare:*"]

[tasks."kind:prepare:kubeconfig"]
description = "Gets the kubeconfig for the current kind cluster"
run = [
  "mkdir --parents $(dirname ${KUBECONFIG})",
  "kind get kubeconfig --name ${KIND_CLUSTER_NAME} | sed \"s/127.0.0.1:.*/${KIND_CLUSTER_NAME}-control-plane:6443/g\" > ${KUBECONFIG}",
]

[tasks."kind:delete"]
description = "Deletes the kind cluster"
run = "kind delete cluster --name ${KIND_CLUSTER_NAME}"

# --- Tools
[tools]
helm = "latest"
yq = "latest"
