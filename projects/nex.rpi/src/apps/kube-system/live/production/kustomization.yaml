---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kube-system

resources:
  # Cert-manager for valid certificates
  - ../../base/cert-manager
  - cm-issuer-letsencrypt.yaml

  # ExternalDNS for managing DNS records
  - ../../base/external-dns
  - edo-secrets.yaml

  # ExternalSecrets for managing secrets
  - ../../base/external-secrets
  - eso-css-kubevault.yaml

  # Traefik for ingress routing
  - ../../base/gateway-api
  - ../../base/traefik
  - gateway-default.yaml

patches:
  # Configure ExternalDNS to work with Cloudflare
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/args/-
        value: --regex-domain-exclusion=.+\\.nr\\.chezmoi\\.sh
      - op: add
        path: "/spec/template/spec/containers/0/env"
        value:
          - name: CF_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: cloudflare-credentials
                # trunk-ignore(checkov/CKV_SECRET_6)
                key: api-token
    target:
      kind: Deployment
      name: external-dns
      namespace: kube-system
